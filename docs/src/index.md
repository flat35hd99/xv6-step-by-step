---
title: xv6ã‚’ã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹
---

[xv6ã®RISC-Vç‰ˆ](mit-pdos/xv6-riscv)ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ã«ä½œæˆã™ã‚‹ã«ã¯ã©ã†ã‚„ã‚Œã°ã„ã„ã®ã‹èª¿ã¹ã¾ã™ã€‚å°‘ã—ãšã¤ä½œæˆã™ã‚‹ã«ã‚ãŸã‚Šã€å¸¸ã«ãªã«ã‹ã—ã‚‰ã®OSãŒå‹•ãã€ã‹ã¤ãã‚ŒãŒæ­£å¸¸ã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã§ãã‚‹è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’ãƒ¡ãƒ³ãƒ†ã—ãªãŒã‚‰é–‹ç™ºã™ã‚‹æ–¹æ³•ã‚’æ¨¡ç´¢ã—ã¾ã™ã€‚

## Hello, world

QEMUä¸Šã§å‹•ãã€"Hello, world!" OSã‚’ä½œæˆã—ã¾ã™ã€‚

QEMUä¸Šã§å‹•ã‹ã™ã®ã¯ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ã‚’è‡ªåˆ†ã§æ›¸ã„ãŸã‚Šã€ä»•æ§˜ã‚’èª¿ã¹ãŸã‚Šã—ãªãã¦ã‚ˆã„ãŸã‚ã€æ¯”è¼ƒçš„ç°¡å˜ã§ã™ã€‚`-kernel`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ¸¡ã—ãŸelfãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ãƒ¢ãƒªä¸Šã«å±•é–‹ã—ã¦ãã‚Œã‚‹ãŸã‚ã€é©åˆ‡ãªãƒ¡ãƒ¢ãƒªé…ç½®ã«ãªã‚‹ã‚ˆã†ã«ã™ã‚Œã°ã‚ˆã„ã§ã™ã€‚ãã®ãŸã‚ã€ãƒ¡ãƒ¢ãƒªé…ç½®ã‚’æŒ‡ç¤ºã™ã‚‹ãŸã‚ã®ãƒªãƒ³ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ•ã‚¡ã‚¤ãƒ«æœ¬ä½“ã‚’ç”¨æ„ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

æœ¬å®¶ã§ã¯ã€ãã‚Œãã‚Œ`kernel.ld`ã¨`entry.S`, `main.c`ãŒå¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«åã§ä½œæˆã—ã¾ã™ã€‚

åˆæœŸåŒ–ã¯ä»¥ä¸‹ã®æµã‚Œã§è¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

- `main.c/main()`
  - `console.c/consoleinit()`
    - `console.c/uartinit()`
  - `printf.c/printfinit()`

`printf()`ã®ä¸­èº«ã‹ã‚‰ã€`uart.c`ã®ã„ã‚ã„ã‚ãŒä½¿ã‚ã‚Œã¦ã‚‹ã®ãŒã‚ã‹ã‚‹ã®ã§ã€ãã‚Œã‚‰ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¨å®Ÿè¡Œã¯ã€ãã‚Œãã‚Œ `compile.sh`ã¨`run.sh`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§è¡Œãˆã¾ã™ã€‚ã©ã¡ã‚‰ã‚‚æœ¬å®¶ã®Makefileã‹ã‚‰æŒã£ã¦ãã¦ã„ã¾ã™ã€‚

```console
$ cd /path/to/xv6-step-by-step
$ ./compile.sh
$ ./run.sh
hello, world
```

å®Ÿè¡Œã™ã‚‹ã¨ã€"hello, world"ã®æ–‡å­—åˆ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸğŸ‰ğŸ‰ğŸ‰

### ãŠã•ã‚‰ã„

- QEMUã§Hello, Worldã«æˆåŠŸã—ãŸã€‚
- ã¨ã‚Šã‚ãˆãšå‹•ã‹ã™ãŸã‚ã€ç´°ã‹ã„ãŠè©±ã€ãŸã¨ãˆã°UARTã®ä»•æ§˜ã‚„ãƒ­ãƒƒã‚¯å‘¨ã‚Šã«ã¤ã„ã¦ã¯è§¦ã‚Œãªã‹ã£ãŸã€‚
- CPUæ•°ã¯1ã¤ã§å®Ÿè¡Œã—ãŸã€‚

## ãƒãƒ«ãƒã‚³ã‚¢ã§Hello, World!

`run.sh`ã¨`start.c`ã®CPUSã®å®£è¨€ã‚’`1`ã‹ã‚‰`2`ã¸å¤‰æ›´ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«`hello, world`ãŒé€£ç¶šã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```
$ ./run.sh 
hello, world
hello, world
```

å•é¡Œãªã•ãã†ã§ã™ã€‚ã“ã“ã‹ã‚‰ã€cpuæ•°ã«å¿œã˜ã¦ã€è¡¨ç¤ºã•ã‚Œã‚‹`hello, world`ã®æ•°ãŒæ¯”ä¾‹ã—ã¦å¢—åŠ ã™ã‚‹ã¨äºˆæƒ³ã§ãã¾ã™ã€‚CPUS=3ã®ã¨ãã‚’è©¦ã™ã¨

```
$ ./run.sh 
hhello, world
ello, world
hello, world
```

æ®‹å¿µãªãŒã‚‰å´©ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚ã“ã‚Œã¯ãã£ã¨ã€è¤‡æ•°ã®ã‚³ã‚¢ãŒåŒæ™‚ã«ä¸€ã¤ã®UARTã®ãƒãƒƒãƒ•ã‚¡ã‹ãƒ¬ã‚¸ã‚¹ã‚¿ã€ã¾ãŸã¯ãã®ä¸¡æ–¹ã¸æ›¸ãè¾¼ã¿ã‚’è¡Œã£ã¦ã„ã‚‹ãŸã‚ã«ç”Ÿã˜ã‚‹ç¾è±¡ã ã¨æ¨å¯Ÿã•ã‚Œã¾ã™ã€‚ã„ã‚ã‚†ã‚‹ã€"race condition"ã§ã™ã€‚

## debug

loadxå‰ã€‚

- 0xA0000000: ãªã‚“ã‹é…ç½®ã•ã‚Œã¦ã‚‹
- 0x40000000: ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã‹ã£ãŸã€‚

```
StarFive # md 0xA0000000
a0000000: 5f746466 68676968 6678303d 66666666  fdt_high=0xfffff
a0000010: 66666666 66666666 0a666666 74696e69  fffffffffff.init
a0000020: 685f6472 3d686769 66667830 66666666  rd_high=0xffffff
a0000030: 66666666 66666666 6b0a6666 656e7265  ffffffffff.kerne
a0000040: 64615f6c 725f7264 3478303d 30303034  l_addr_r=0x44000
a0000050: 0a303030 6e72656b 635f6c65 5f706d6f  000.kernel_comp_
a0000060: 72646461 303d725f 30303978 30303030  addr_r=0x9000000
a0000070: 656b0a30 6c656e72 6d6f635f 69735f70  0.kernel_comp_si
a0000080: 303d657a 30303178 30303030 64660a30  ze=0x10000000.fd
a0000090: 64615f74 725f7264 3478303d 30303038  t_addr_r=0x48000
a00000a0: 0a303030 646d6172 5f6b7369 72646461  000.ramdisk_addr
a00000b0: 303d725f 31383478 30303030 20230a30  _r=0x48100000.#
a00000c0: 65766f4d 73696420 206f7274 66206f74  Move distro to f
a00000d0: 74737269 6f6f6220 6f742074 65707320  irst boot to spe
a00000e0: 75206465 6f622070 6e69746f 6f620a67  ed up booting.bo
a00000f0: 745f746f 65677261 643d7374 72747369  ot_targets=distr
StarFive # 0X40000000
Unknown command '0X40000000' - try 'help'
StarFive # md 0x40000000
Unhandled exception: Load access fault
EPC: 00000000fffa010e RA: 00000000fffa005c TVAL: 0000000040000000
EPC: 000000004025a10e RA: 000000004025a05c reloc adjusted

SP:  00000000ff7358c0 GP:  00000000ff735e00 TP:  0000000000000001
T0:  00000000ff735b40 T1:  0000000000000039 T2:  0000000000000000
S0:  0000000000000004 S1:  0000000000000004 A0:  0000000000000004
A1:  00000000fffb6c98 A2:  00000000fffb9806 A3:  fffffffffffffffe
A4:  0000000000000008 A5:  0000000000000000 A6:  0000000000000002
A7:  0000000000000004 S2:  00000000ff735a99 S3:  0000000000000004
S4:  00000000ff7359d8 S5:  0000000040000000 S6:  0000000000000000
S7:  00000000ff7359d8 S8:  0000000000000008 S9:  00000000ff7359d8
S10: 0000000000000008 S11: 0000000000000004 T3:  0000000000000010
T4:  0000000000000000 T5:  000000000001869f T6:  00000000ff735b20

Code: 6c0a 7ce6 7d46 7da6 6169 8082 9c63 03b4 (a683 000a)


resetting ...
reset not supported yet
### ERROR ### Please RESET the board ###
```

loadxã—ã¦ã‹ã‚‰mdã—ã¦ã¿ã‚‹ã€‚

loadxã—ãŸã‚‰`0xA0000000`ã«é…ç½®ã•ã‚ŒãŸã®ã§ã€

```
StarFive # md 0xA0000000
a0000000: 464c457f 00010102 00000000 00000000  .ELF............
a0000010: 00f30002 00000001 40000000 00000000  ...........@....
a0000020: 00000040 00000000 00002f50 00000000  @.......P/......
a0000030: 00000005 00380040 00400002 00120013  ....@.8...@.....
a0000040: 00000001 00000007 00001000 00000000  ................
a0000050: 40000000 00000000 40000000 00000000  ...@.......@....
a0000060: 00001030 00000000 00003060 00000000  0.......`0......
a0000070: 00001000 00000000 6474e551 00000006  ........Q.td....
a0000080: 00000000 00000000 00000000 00000000  ................
a0000090: 00000000 00000000 00000000 00000000  ................
a00000a0: 00000000 00000000 00000010 00000000  ................
a00000b0: 00000000 00000000 00000000 00000000  ................
a00000c0: 00000000 00000000 00000000 00000000  ................
a00000d0: 00000000 00000000 00000000 00000000  ................
a00000e0: 00000000 00000000 00000000 00000000  ................
a00000f0: 00000000 00000000 00000000 00000000  ................
```

`bootelf`ã¯æ­»ã¬ã€‚`iminfo`ã¯èªè­˜ã§ããªã„ã¨ã„ã†ã€‚

### elfã®èªè­˜è‡ªä½“ãŒãƒ€ãƒ¡ï¼Ÿ

ã©ã†ã‚„ã‚‰return codeã‚’u-bootå´ã§æ‹¾ãˆã‚‹ã‚‰ã—ã„ã®ã§ã€

```c
void main() {
  return 42;
}
```

ã¨ã„ã†ç°¡å˜ãªã‚³ãƒ¼ãƒ‰ã‚’ `riscv64-linux-gnu-gcc main.c` ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸã€‚`a.out`ã¨ã„ã†åå‰ã ãŒã€elfå½¢å¼ã‚‰ã—ã„ã€‚

```console
StarFive # loadx
## Ready for binary (xmodem) download to 0xA0000000 at 115200 bps...
C## Total Size      = 0x000020c8 = 8392 Bytes
StarFive # iminfo

## Checking Image at a0000000 ...
Unknown image format!
```

ğŸ˜«

```console
StarFive # md a0000000
a0000000: 464c457f 00010102 00000000 00000000  .ELF............
a0000010: 00f30003 00000001 00000520 00000000  ........ .......
a0000020: 00000040 00000000 00001a08 00000000  @...............
a0000030: 00000005 00380040 00400009 001a001b  ....@.8...@.....
a0000040: 00000006 00000004 00000040 00000000  ........@.......
a0000050: 00000040 00000000 00000040 00000000  @.......@.......
a0000060: 000001f8 00000000 000001f8 00000000  ................
a0000070: 00000008 00000000 00000003 00000004  ................
a0000080: 00000238 00000000 00000238 00000000  8.......8.......
a0000090: 00000238 00000000 00000021 00000000  8.......!.......
a00000a0: 00000021 00000000 00000001 00000000  !...............
a00000b0: 00000001 00000005 00000000 00000000  ................
a00000c0: 00000000 00000000 00000000 00000000  ................
a00000d0: 00000694 00000000 00000694 00000000  ................
a00000e0: 00001000 00000000 00000001 00000006  ................
a00000f0: 00000df8 00000000 00001df8 00000000  ................
```

ã¡ã‚ƒã‚“ã¨ELFã«è¦‹ãˆã‚‹ã€‚

```console
StarFive # bootelf -p a0000000
## Not a 32-bit elf image at address 0xa0000000
```

32bitã˜ã‚ƒãªã„ã¨æ€’ã‚‰ã‚Œã¦ã‚‹ã€‚`-s`ã§ã‚‚åŒã˜ã ã£ãŸã€‚

## objcopyã‚’ä½¿ã£ã¦raw binaryã«ã—ã¦goã§èµ·å‹•

ç”Ÿæˆ

```console
riscv64-linux-gnu-as -mabi=lp64 -o hello hello.S
riscv64-linux-gnu-objcopy -O binary hello hello.bin
riscv64-linux-gnu-objcopy -O binary kernel/kernel kernel.bin
```

```console
StarFive # loadx
## Ready for binary (xmodem) download to 0xA0000000 at 115200 bps...
C## Total Size      = 0x00001030 = 4144 Bytes

```

recoveryã¯å‹•ãã®ã‹è¦‹ã‚‹

```
Welcome to minicom 2.8

OPTIONS: I18n
Port /dev/serial0, 00:34:43

Press CTRL-A Z for help on special keys

CCCCCCCCCCCC
JH7110 secondboot version: 221205-74596a9
CPU freq: 1250MHz
idcode: 0x1860C8
ddr 0x00000000, 4M test
ddr 0x00400000, 8M test
DDR clk 2133M, size 4GB

*********************************************************
****************** JH7110 program tool ******************
*********************************************************
0: update 2ndboot/SPL in flash
1: update 2ndboot/SPL in emmc
2: update fw_verif/uboot in flash
3: update fw_verif/uboot in emmc
4: update otp, caution!!!!
5: exit
NOTE: current xmodem receive buff = 0x40000000, 'load 0x********' to change.
```

### ã™ã”ã„å˜ç´”ãªå ´åˆ

```assembly
.section .text
.global _entry
_entry:
        li ra, 42
spin:
        j spin

```

```console
StarFive # md a0000000
a0000000: 464c457f 00010102 00000000 00000000  .ELF............
a0000010: 00f30002 00000001 a0000000 00000000  ................
a0000020: 00000040 00000000 00002130 00000000  @.......0!......
a0000030: 00000005 00380040 00400002 00070008  ....@.8...@.....
a0000040: 00000001 00000005 00001000 00000000  ................
a0000050: a0000000 00000000 a0000000 00000000  ................
a0000060: 00001000 00000000 00001000 00000000  ................
a0000070: 00001000 00000000 00000001 00000006  ................
a0000080: 00002000 00000000 a0001000 00000000  . ..............
a0000090: a0001000 00000000 00000000 00000000  ................
a00000a0: 00000000 00000000 00001000 00000000  ................
a00000b0: 00000000 00000000 00000000 00000000  ................
a00000c0: 00000000 00000000 00000000 00000000  ................
a00000d0: 00000000 00000000 00000000 00000000  ................
a00000e0: 00000000 00000000 00000000 00000000  ................
a00000f0: 00000000 00000000 00000000 00000000  ................
StarFive # bootelf
## Starting application at 0x00000000 ...
Unhandled exception: Instruction access fault
EPC: 0000000000000000 RA: 00000000fff4b0d0 TVAL: 0000000000000000
EPC: ffffffff402ba000 RA: 00000000402050d0 reloc adjusted

SP:  00000000ff735a30 GP:  00000000ff735e00 TP:  0000000000000001
T0:  00000000a0001000 T1:  00000000fff47262 T2:  0000000000000000
S0:  0000000000000000 S1:  0000000000000001 A0:  0000000000000000
A1:  00000000ff758a98 A2:  000000000000000a A3:  fffffffffffffffe
A4:  0000000000000002 A5:  0000000000000000 A6:  0000000000000021
A7:  0000000000000000 S2:  0000000000000000 S3:  00000000ff758a98
S4:  0000000000000000 S5:  0000000000000001 S6:  0000000000000000
S7:  00000000ff758ad0 S8:  0000000000000000 S9:  0000000000000000
S10: 0000000000000000 S11: 0000000000000000 T3:  0000000000000010
T4:  0000000000000000 T5:  0000000000000000 T6:  00000000a0000000
Unhandled exception: Load access fault
EPC: 00000000fff473f2 RA: 00000000fff473f2 TVAL: 0000000000000000
EPC: 00000000402013f2 RA: 00000000402013f2 reloc adjusted

SP:  00000000ff7358d0 GP:  00000000ff735e00 TP:  0000000000000001
T0:  00000000a0001000 T1:  00000000fff47262 T2:  0000000000000000
S0:  0000000000000000 S1:  0000000000000000 A0:  0000000000000042
A1:  0000000000000000 A2:  000000000000000a A3:  fffffffffffffffe
A4:  0000000000000002 A5:  0000000010000000 A6:  000000000000000f
A7:  0000000000000000 S2:  0000000000000000 S3:  0000000000000002
S4:  0000000000000000 S5:  0000000000000001 S6:  0000000000000000
S7:  00000000ff758ad0 S8:  0000000000000000 S9:  0000000000000000
S10: 0000000000000000 S11: 0000000000000000 T3:  0000000000000010
T4:  0000000000000000 T5:  0000000000000000 T6:  00000000a0000000

Code: 2517 0006 0513 0b65 f413 ffe4 b0ef 27d5 (5783 0004)
```
